# 419 Page Expired Error - Root Cause & Fix

## Problem

Users encountered a **419 Page Expired** error when attempting to log in. This is a CSRF token mismatch error that occurs when Laravel's CSRF middleware rejects a request due to an invalid or missing token.

## Root Cause

The issue was in `resources/js/Pages/Auth/Login.jsx`:

1. **Manual CSRF Token Extraction**: The login form was manually extracting the CSRF token from the meta tag using `document.querySelector('meta[name="csrf-token"]')`.

2. **Double Token Injection**: The form was using `transform()` to manually append `_token` to the payload.

3. **Conflict with Global Handler**: Simultaneously, the global Inertia handler in `resources/js/app.jsx` (lines 69-106) was **also** injecting the CSRF token automatically.

4. **Token Mismatch**: This double injection caused:
   - Token value mismatches
   - Session state inconsistencies
   - CSRF validation failures

## Solution

**Remove manual CSRF token handling from the login form** and rely on the global Inertia CSRF handler.

### Before (Broken)
```javascript
const submit = (e) => {
    e.preventDefault();
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

    transform((formData) => ({
        ...formData,
        ...(csrfToken ? { _token: csrfToken } : {}),
    }));

    post(route('login'), {
        onFinish: () => {
            reset('password');
            transform((formData) => formData);
        },
    });
};
```

### After (Fixed)
```javascript
const submit = (e) => {
    e.preventDefault();

    post(route('login'), {
        onFinish: () => {
            reset('password');
        },
    });
};
```

## How It Works Now

1. **Global Handler** (`app.jsx` lines 69-106):
   - Listens to all Inertia router `before` events
   - Automatically injects `X-CSRF-TOKEN` header for POST/PUT/DELETE requests
   - Automatically appends `_token` to FormData or JSON payloads
   - Retrieves token from `router.page.props.csrf_token` or meta tag

2. **Login Form**:
   - Simply calls `post(route('login'), data)`
   - Inertia router handles CSRF token injection automatically
   - No manual token extraction needed

## Files Changed

- `resources/js/Pages/Auth/Login.jsx` - Removed manual CSRF token handling
- `resources/js/__tests__/loginCsrf.test.js` - Updated test to verify global handler usage

## Testing

All tests pass:
```bash
npm run test
# Result: 41/41 tests passing
```

## Key Takeaway

**Never manually inject CSRF tokens in Inertia forms.** The framework's global handler is designed to manage this consistently across all requests. Manual injection causes conflicts and token mismatches.

## References

- Inertia.js CSRF Protection: https://inertiajs.com/security
- Laravel CSRF Protection: https://laravel.com/docs/11.x/csrf
- Global CSRF Handler: `resources/js/app.jsx` lines 69-106
